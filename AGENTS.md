# Agentic Instructions for latex-rs

Welcome, Agent. This file centralizes instructions and context for AI agents working on the `latex-rs` project.

## Project Overview
`latex-rs` is a GTK-based LaTeX editor written in Rust. It features real-time LaTeX preview via KaTeX (rendered in WebKit2gtk) and AI assistance via local Ollama integration.

## Key Technologies
- **Rust**: Primary programming language.
- **GTK 3**: UI framework (`gtk-rs`).
- **WebKit2GTK**: Used for the preview pane to render HTML/KaTeX.
- **KaTeX**: Fast LaTeX math rendering.
- **Ollama**: Local AI inference engine (`http://localhost:11434`).
- **GtkSourceView**: For syntax highlighting in the editor.

## Architecture
- [src/main.rs](src/main.rs): Entry point, UI layout, and signal connectivity.
- [src/preview.rs](src/preview.rs): HTML generation for the preview pane using `horrorshow`.
- [src/api.rs](src/api.rs): Client for interacting with the Ollama API (using `qwen3:0.6b`).
- [src/utils.rs](src/utils.rs): Helpers and macros (e.g., `clone!`).

## Critical Patterns
### Memory Management & Closures
GTK follows a reference-counted model for widgets. When using widgets in closures (e.g., signal handlers), use the `clone!` macro provided in [src/utils.rs](src/utils.rs).
```rust
text_buffer.connect_changed(clone!(@strong web_view, preview => move |buffer| { ... }));
```

### Async Operations
GTK signal handlers run on the main thread. AI calls (Ollama) are async and should use `glib::MainContext` or similar patterns to avoid blocking the UI. Refer to [src/main.rs](src/main.rs) for implementation details.

### HTML Previews
The preview is an HTML string generated by `horrorshow`. It includes KaTeX and Highlight.js via CDN. Modifications to the preview layout should happen in [src/preview.rs](src/preview.rs).

## Knowledge Base
- **Architecture**: See [AGENTS.md](AGENTS.md) (this file).
- **Project Memory**: See [MEMORY.md](MEMORY.md) for project status and decisions.
- **Specific Skills**: See [SKILL.md](SKILL.md) for Rust-GTK patterns.
- **Developer Tools**: See [TOOLS.md](TOOLS.md) for build and test commands.

## Workflow Guidelines
1. **Context Check**: Before starting a task, read [MEMORY.md](MEMORY.md) to understand current progress.
2. **Code Style**: Follow standard Rust formatting (`rustfmt`).
3. **Safety**: Always use the `clone!` macro for GTK signal handlers as documented in [SKILL.md](SKILL.md).
4. **Verification**: After UI changes, guide the user to run `cargo run` and manually verify the change, as automated UI testing is limited.

## UI Changes
- Check [src/main.rs](src/main.rs) for UI programmatic changes.
- AI Features: Updates to the AI prompt or logic should go into [src/api.rs](src/api.rs) and be triggered in [src/main.rs](src/main.rs).
- Styling: Inline CSS is embedded in the `horrorshow` HTML macro in [src/preview.rs](src/preview.rs). No external stylesheets are used.

## Requirements for Environment
- System libraries: `libgtk-4-dev`, `libadwaita-1-dev`, `libgtksourceview-5-dev`, `libwebkitgtk-6.0-dev`.
- Local Ollama instance for AI feature testing.
